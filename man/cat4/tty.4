
TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


ИИММЯЯ
        ttttyy - универсальный терминальный интерфейс.

ФФООРРММААТТ
        #iinncclluuddee <_s_g_t_t_y._h>

ООППИИССААННИИЕЕ
        В этом разделе  приводится  описание  универсального
        терминального  интерфейса, который используется сис-
        темой для работы со всеми доступными линиями связи.

        ДДииссццииппллиинныы ооббссллуужжиивваанниияя

        ДДЕЕММООСС позволяет применять различные стратегии обслу-
        живания  обмена  с  терминалом и первичной обработки
        информации, передаваемой по линиям связи.  Это  дос-
        тигается с помощью механизма дисциплин обслуживания,
        встроенного в  универсальный  терминальный  драйвер.
        Данная  версия  системы  поддерживает  три различных
        стратегии обслуживания обмена по терминальным линиям
        связи:

        _o_l_d     Стандартная дисциплина.  Реализует стандарт-
                ную  для  операционных  систем  типа Unix (и
                ранних версий ДДЕЕММООСС) стратегию  обслуживания
                работы   с  терминалом.  В  настоящее  время
                используется только по соображениям  совмес-
                тимости.

        _n_e_w     Новая дисциплина. Является расширением стан-
                дартной  дисциплины и предназначена для под-
                держки   аппарата   управления    процессами
                командного языка _c_s_h(1).

        _n_e_t     Сетевая дисциплина. Предназначена для  орга-
                низации  межмашинного  обмена информацией по
                терминальным линиям связи.

        Для подключения конкретной  дисциплины  обслуживания
        служит системный вызов iiooccttll. Например:

                iinntt _l_d_i_s_c = _L_D_I_S_C;
                iiooccttll (_f_d, TTIIOOCCSSEETTDD, &_l_d_i_s_c);

        подключает дисциплину обслуживания с  номером  _L_D_I_S_C
        для организации обмена с терминалом, соответствующим
        дескриптору _f_d.  По соглашению, стандартная  дисцип-
        лина обслуживания имеет номер 0 или OOTTTTYYDDIISSCC.  Новая
        и сетевая дисциплины обслуживания  имеют  соответст-
        венно  номера  NNTTTTYYDDIISSCC  и  NNEETTLLDDIISSCC.  Для получения
        номера текущей дисциплины обслуживания может исполь-
        зоваться тот же вызов iiooccttll с запросом TTIIOOCCGGEETTDD. При
        смене дисциплины обслуживания уничтожаются все  пос-
        тупившие  к этому моменту, но еще не переданные про-
        цессу, символы.

        Данные дисциплины обслуживания могут применяться для
        организации    обмена   по   любым   низкоскоростным


                            -1-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        асинхронным линиям связи независимо  от  типа  соот-
        ветствующей  им  аппаратуры. Более детальные отличия
        дисциплин _o_l_d и _n_e_w будут рассмотрены ниже.

        УУппррааввлляяюющщиийй ттееррммииннаалл

        При открытии специального файла, с помощью  которого
        обеспечивается  доступ  к терминалу, процесс перево-
        дится в состояние ожидания до установления  соедине-
        ния  по  линии  связи.  В действительности, процессы
        пользователей всегда работают с уже  открытым  (дос-
        тупным)  терминалом, который подключается в качестве
        стандартных файлов ввода/вывода  процесса  системным
        процессом  _i_n_i_t(8).  Этот терминал называется управ-
        ляющим терминалом  процесса.   Управляющей  терминал
        наследуется  всеми  потомками данного процесса, даже
        если данный процесс закрывает его.

        Файл /_d_e_v/_t_t_y является для каждого процесса  синони-
        мом  связанного  с ним управляющего терминала.  Этот
        файл предназначен для тех программ, которым  необхо-
        димо работать с экраном терминала вне зависимости от
        того, каким образом было изменено направление  стан-
        дартного ввода/вывода.

        ДДооссттуупп кк ттееррммииннааллуу

        В системе может одновременно существовать  несколько
        процессов,  имеющих один и тот же управляющий терми-
        нал. Командные языки (например, _c_s_h(1)) могут управ-
        лять   доступом   к  экрану,  "приписывая"  терминал
        какому-либо процессу или группе  процессов.  В  этом
        случае  все  процессы,  относящиеся  к  иной группе,
        будут приостанавливаться при попытке обмена с управ-
        ляющим  терминалом. Для задания активной группы про-
        цессов служит системный вызов:

                iiooccttll (_f_d, TTIIOOCCSSPPGGRRPP, &_p_g_r_p);

        Запрос TTIIOOCCGGPPGGRRPP может использоваться для  получения
        идентификатора текущей группы процессов.

        РРеежжииммыы ррааббооттыы

        Существуют три основных режима обработки  информации
        при вводе/выводе:

        _C_O_O_K_E_D  Стандартный  режим.  Все  введенные  символы
                буферизуются  и  передаются  процессу только
                после ввода признака конца строки или  приз-
                нака  конца передачи (EEOOTT - обычно, CCTTRRLL//DD).
                Допускается редактирование  входной  строки,
                обрабатываются  все  специальные  символы  и
                выполняется    необходимое    преобразование
                информации  при вводе/выводе (перекодировки,
                отработки задержек и т.д.).

        _C_B_R_E_A_K  В этом режиме символы  передаются  программе


                            -2-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


                непосредственно  после  ввода  с клавиатуры.
                Редактирование входной  строки  отсутствует,
                однако,  обрабатываются все остальные специ-
                альные  символы  и  выполняются  необходимые
                преобразования информации при вводе/выводе.

        _R_A_W     Прозрачный  режим.  Все  символы  передаются
                программе  непосредственно  после  ввода без
                каких-либо преобразований.

        Стандартно при чтении с  терминала  процесс  перево-
        дится  в  состояние  ожидания  до  ввода информации.
        Если был  задан  режим  неблокирующего  ввода/вывода
        (см.  _i_o_c_t_l_n_e_w(2)), то системный вызов _r_e_a_d(2) будет
        фиксировать ошибку типа EEWWOOUULLDDBBLLOOCCKK  при  отсутствии
        доступной информации.

        ООббррааббооттккаа ииннффооррммааццииии ппррии ввввооддее

        Система обслуживает терминалы, работающие  только  в
        дуплексном режиме.  Символы могут вводиться с клави-
        атуры терминала в любое время, даже во время  печати
        выводимой  информации.   Потеря  символов  при вводе
        может происходить только в случае переполнения  сис-
        темных  буферов (что случается крайне редко) или при
        превышении предела на максимально  допустимое  коли-
        чество  введенных  символов,  которые еще не считаны
        каким-либо процессом (в настоящее время этот  предел
        равен  256 символам).  Система пытается диагностиро-
        вать подобную ситуацию передачей  звукового  сигнала
        на соответствующем терминале.

        Отрабатывается контроль четности вводимых символов и
        производятся   необходимые   перекодировки.   Данный
        вариант драйвера обслуживает терминалы, работающие в
        кодах  AASSCCIIII, ККООИИ--77 и ККООИИ--88.  Для включения обслужи-
        вания кодов ККООИИ--77, ККООИИ--88  служит  признак  CCYYRRIILLLL  в
        шкале основных режимов работы терминального драйвера
        (см. Общее описание).

        Все дисциплины обслуживания  позволяют  симулировать
        ввод символа с терминала. Это производится с помощью
        запроса  TTIIOOCCSSTTII  системного  вызова   _i_o_c_t_l(2),   в
        качестве  третьего  параметра  этого вызова задается
        адрес символа. Этот запрос выполняется, только  если
        указанный  терминал  является управляющим терминалом
        процесса или процесс  работает  в  привилегированном
        режиме.

        Обычно при вводе символ '\r' (CCRR, ВВКК) заменяется  на
        символ '\n' (NNLL, ППСС), а при выводе символ '\n' заме-
        няется на последовательность символов '\r\n'.  Этого
        соглашение  можно  отменить,  убрав  признак CCRRMMOODD в
        шкале  основных  режимов  терминального  драйвера  с
        помощью  запросов  TTIIOOCCSSEETTNN,  TTIIOOCCSSEETTPP, TTIIOOCCSSEETTAA или
        TTIIOOCCSSEETTBB системного вызова _i_o_c_t_l(2).




                            -3-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        Ввод производится с автоматической эхо-печатью  вво-
        димого  символа.   Этот  режим можно отменить, убрав
        признак EECCHHOO из шкалы основных режимов.

        Как уже говорилось, в режиме _C_O_O_K_E_D единицей  обмена
        при  вводе с терминала является строка.  В системном
        вызове _r_e_a_d(2) не требуется указывать точный  размер
        строки.   За одно обращение будет передано запрошен-
        ное число символов, а остальные можно  получить  при
        последующих обращениях.

        Во время ввода данных можно отменить последний  вве-
        денный  символ  или  всю  строку. Специальный символ
        ssgg__kkiillll (обычно DDEELL) отменяет последний введенный  с
        клавиатуры символ, а символ ssgg__eerraassee (обычно CCTTRRLL//UU)
        - все введенные символы.  В любом  случае,  удаление
        ведется  до  начала  входной  строки либо до символа
        CCTTRRLL//DD (EEOOTT - конец передачи).

        Для ввода любого символа, имеющего специальное  зна-
        чение, может использоваться символ CCTTRRLL//VV в качестве
        признака ввода без обработки.

        Дисциплина  обслуживания  _n_e_w  предоставляет   более
        широкие  возможности  редактирования входной строки.
        Обычно символ CCTTRRLL//WW  отменяет  последнее  введенное
        слово. Словом считается последовательность символов,
        не  разделенная  символами  пробела  или  табуляции.
        Слово отменяется вместе с предшествующими ему пробе-
        лами. Существует  возможность  перевыдать  введенную
        часть  строки.  Для  этой  цели может использоваться
        специальный символ CCTTRRLL//RR.   Следует  отметить,  что
        строка  автоматически перевыдается, если ввод строки
        был нарушен выводом какого-либо процесса.

        РРааббооттаа  сс  ттееррммииннааллааммии,,  ииммееюющщииммии  ттооллььккоо  ппррооппиисснныыее
        ббууккввыы..

        Режим работы с терминалами, имеющими только  пропис-
        ные  буквы,  управляется  значениями  LLCCAASSEE, CCYYRRIILLLL,
        SSIISSOO и UUCCAASSEE шкалы  основных  режимов  терминального
        драйвера.  Значение LLCCAASSEE включает данный режим пре-
        образования информации  на  вводе/выводе.  Остальные
        значения указывают определенные особенности преобра-
        зования.

        При вводе информации применяется следующая стратегия
        преобразования  символов.  Считается, что на клавиа-
        туре терминала кроме строчных букв отсутствуют  сим-
        волы  '{', '}', '|', '^' и '`'.  Если не стоит приз-
        нак CCYYRRIILLLL то предполагается, что терминал  работает
        в кодировке AASSCCIIII.  В этом случае:

          - все прописные буквы переводятся в строчные;

          - если букве  предшествует  символ  '\',  вводится
            прописная буква;



                            -4-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


          - если символам '(', ')',  '!',  '~',  '\'  и  '''
            предшествует символ '\', вводятся соответственно
            символы '{', '}', '|', '^', '\' и '`'.

        Если установлен признак CCYYRRIILLLL, считается, что  тер-
        минал  работает  в  коде  ККООИИ--77. В этом случае, если
        стоит признак SSIISSOO, для переключения с латинской  на
        русскую      клавиатуру     используются     символы
        CCTTRRLL//NN/CCTTRRLL//OO, а для ввода  прописных/строчных  букв
        клавиша переключения верхнего/нижнего регистра. Если
        признак SSIISSOO не стоит, то считается, что  клавиатура
        имеет  русские  и  латинские строчные символы, а для
        ввода прописных букв и отсутствующих знаков  исполь-
        зуется символ '\'.

        При выводе информации все строчные буквы  преобразу-
        ются  в  прописные, а перед прописными буквами выда-
        ется символ '\'. Отсутствующие  знаки  преобразуются
        на следующие последовательности символов:

                знак            {   }   |   ^   `
                отображение    \(  \)  \!  \~  \'

        Если _н_е _у_с_т_а_н_о_в_л_е_н режим UUCCAASSEE, выделение  прописных
        букв символом '\' не используется.

        УУппррааввллееннииее ппррооццеессссааммии

        В системе может существовать  только  один  процесс,
        которому  разрешен  ввод  с  терминала. Это свойство
        используется терминальным драйвером  для  управления
        выполнением процесса. Терминальный драйвер обрабаты-
        вает ряд специальных символов, ввод которых приводит
        к  передаче определенного сигнала текущему процессу.
        Процесс может быть прерван, приостановлен и  продол-
        жен.

        УУппррааввллееннииее ддооссттууппоомм кк ттееррммииннааллуу

        Новая дисциплина  обслуживания  реализует  следующую
        стратегию  разделения  доступа  к терминалу: как уже
        говорилось, в системе может существовать только один
        процесс,  которому  разрешен  ввод  с  терминала,  и
        группа процессов, которым разрешен вывод  на  терми-
        нал.   При  попытке чтения с терминала фоновому про-
        цессу всегда передается сигнал SSIIGGTTTTIINN, который при-
        водит к остановке этого процесса.

        Если установлен признак LLTTOOSSTTOOPP дополнительной шкалы
        режимов,  то запрещается вывод на терминал всем про-
        цессам, не входящим в  установленную  для  терминала
        группу. При попытке вывода этим процессам передается
        сигнал SSIIGGTTTTOOUU.

        ООббщщееее ооппииссааннииее

        Базовая управляющая структура определена в  include-
        файле _s_g_t_t_y._h и имеет следующий вид:


                            -5-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


                ssttrruucctt ssggttttyybb {
                    cchhaarr    ssgg__iissppeeeedd;
                    cchhaarr    ssgg__oossppeeeedd;
                    cchhaarr    ssgg__eerraassee;
                    cchhaarr    ssgg__kkiillll;
                    sshhoorrtt   ssgg__ffllaaggss;
                };

        Поля  ssgg__iissppeeeedd  и  ssgg__oossppeeeedd  определяют   скорость
        обмена  по  линии при вводе и выводе соответственно.
        Если  оборудование  не  поддерживает  какую-либо  из
        определенных ниже скоростей, установка подобной ско-
        рости передачи игнорируется.

                B0      0       отключение линии
                B50     1       50   бод
                B75     2       75   бод
                B110    3       110  бод
                B134    4       134.5 бод
                B150    5       150  бод
                B200    6       200  бод
                B300    7       300  бод
                B600    8       600  бод
                B1200   9       1200 бод
                B1800   10      1800 бод
                B2400   11      2400 бод
                B4800   12      4800 бод
                B9600   13      9600 бод
                EXTA    14
                EXTB    15

        Значения EEXXTTAA и EEXXTTBB могут использоваться для  опре-
        деления  нестандартных  значений  скорости  передачи
        данных и зависят от постановки системы.

        Поля ssgg__kkiillll и ssgg__eerraassee  служат  для  задания  соот-
        ветственно специальных символов отмены строки и пос-
        леднего введенного символа.

        Поле ssgg__ffllaaggss содержит битовую шкалу основных  режи-
        мов  работы терминального драйвера и составляется из
        следующих признаков:

        TTAANNDDEEMM  0000001  Автоматическое управление синхрони-
                         зацией   передачей   информации  по
                         линии связи.

        CCBBRREEAAKK  0000002  Передача символа процессу  по  мере
                         ввода (режим _C_B_R_E_A_K).

        LLCCAASSEE   0000004  Терминал не имеет строчных букв.

        EECCHHOO    0000010  Индикация вводимых символов.

        CCRRMMOODD   0000020  При вводе символ '\r' заменяется на
                         '\n',  при выводе символ '\n' заме-
                         няется на последовательность симво-
                         лов '\r\n'.


                            -6-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        RRAAWW     0000040  Отмена обработки  и  преобразования
                         символов  при вводе/выводе.  (Режим
                         _R_A_W). Если флаги RRAAWW  и  CCBBRREEAAKK  не
                         установлены, драйвер будет работать
                         в режиме _C_O_O_K_E_D.

        OODDDDPP    0000100  Контроль по нечетности при вводе.

        EEVVEENNPP   0000200  Контроль по четности при вводе.

        XXTTAABBSS   0000400  При выводе символы  табуляции  '\t'
                         преобразуются   в   соответствующее
                         число пробелов.

        FFRRAAMMEE77  0001000  Передача по линии 7 значащих бит  в
                         байте.

        DDSSTTOOPPSS  0002000  Передача по линии связи символов  с
                         двумя стоповыми битами.

        CCYYRRIILLLL  0004000  Терминал имеет русские буквы.

        CCSSTTYYLLEE  0070000  Общая  маска  на  тип  переключения
                         регистров  при вводе русских симво-
                         лов.

         CCBBIITTSS88   0000000   Терминал работает в восьмибитном
                            коде  ККООИИ--88 на выводе и переклю-
                            чением       русского/латинского
                            регистров  по CCTTRRLL//NN и CCTTRRLL//OO на
                            вводе.

         CCEELL1155    0010000   Режим     работы      клавиатуры
                            (русская/латинская)   переключа-
                            ется  из  ЭВМ.   При  работе   в
                            режиме  русской  клавиатуры про-
                            писные и строчные буквы меняются
                            местами.   Этот   тип  обработки
                            соответствует       стандартному
                            режиму      работы     терминала
                            Электроника 15ИЭ-00-013.

         CCEELL1155II   0020000   Режим     работы      клавиатуры
                            (русская/латинская)  не переклю-
                            чается из  ЭВМ.   При  работе  в
                            режиме  русской  клавиатуры про-
                            писные и строчные буквы меняются
                            местами.   Этот   тип  обработки
                            соответствует          терминалу
                            Электроника 15ИЭ-00-013 с перек-
                            люченной в тестовый режим клави-
                            атурой, терминалам СМ1611 и т.п.

         CCEELL1155KK   0030000   Режим     работы      клавиатуры
                            (русская/латинская)  не переклю-
                            чается из  ЭВМ.   При  работе  в
                            режиме  русской  клавиатуры про-
                            писные  и  строчные   буквы   не


                            -7-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


                            меняются   местами.  Этот  режим
                            соответствует          терминалу
                            Электроника  15ИЭ-00-013 с моди-
                            фицированной   клавиатурой   или
                            терминалу  VT-220  с загружаемым
                            русским шрифтом.

         CCBBMMKKBBDD   0040000   Режим не используется  (зарезер-
                            вирован  для  терминалов со сме-
                            шанным  набором  кода  КОИ-7   и
                            переключением  больших/маленьких
                            букв по CCTTRRLL//NN и CCTTRRLL//OO).

         CC5522113300   0050000   Режим не используется  (зарезер-
                            вирован для терминалов с нестан-
                            дартным  переключением   регист-
                            ров).

         CCSSIISSOOQQ    0060000  На   выводе    русский/латинский
                            регистры     переключаются    по
                            CCTTRRLL//NN/CCTTRRLL//OO,  на  вводе  также
                            переключается,  как  и  в режиме
                            CCEELL1155II, но используется для тер-
                            миналов  с  клавиатурой  _Q_W_E_R_T_Y.
                            (При вводе  русских  букв  будет
                            использоваться  размещение  _Й_Ц_У_-
                            _К_Е_Н).

         CCBBIITTSS88QQ  0070000   Терминал работает в восьмибитном
                            коде  ККООИИ--88 на выводе и переклю-
                            чением       русского/латинского
                            регистров  по CCTTRRLL//NN и CCTTRRLL//OO на
                            вводе для терминалов с клавиату-
                            рой  _Q_W_E_R_T_Y.  (При вводе русских
                            букв будет использоваться разме-
                            щение _Й_Ц_У_К_Е_Н).

        SSIISSOO  0010000    При  работе  в  коде  ККООИИ--77   режим
                         русской/латинской клавиатуры перек-
                         лючается символами CCTTRRLL//NN/CCTTRRLL//OO, а
                         прописные/строчные  буквы клавишами
                         верхний/нижний регистр.

        UUCCAASSEE 0020000    При выводе на терминал, не  имеющий
                         строчных   букв,   прописные  буквы
                         выделяются символом '\'.

        Кроме уже описанных  запросов  TTIIOOCCSSEETTDD  и  TTIIOOCCGGEETTDD
        системного вызова iiooccttll, использующихся для управле-
        ния дисциплинами обслуживания линии, существует  еще
        несколько  запросов  для  управления режимами работы
        терминального драйвера.  В  общем  случае  обращение
        имеет вид:

                #iinncclluuddee <_s_g_t_t_y._h>

                iiooccttll(_f_d, _r_e_q_u_e_s_t, _a_r_g)



                            -8-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        где _f_d - дескриптор специального файла, через  кото-
        рый обеспечивается доступ к терминалу, _r_e_q_u_e_s_t - тип
        запроса, а _a_r_g - параметры указанной операции. Могут
        использоваться следующие запросы:

        TTIIOOCCGGEETTPP  Получение основных режимов  работы  терми-
                  нального  драйвера.  Параметр _a_r_g является
                  указателем на структуру ssggttttyybb.

        TTIIOOCCSSEETTPP  Установка основных режимов  работы  терми-
                  нального  драйвера.  Параметр _a_r_g является
                  указателем на структуру ssggttttyybb. Перед сме-
                  ной   режимов  на  терминал  выдается  вся
                  накопленная в буфере вывода  информация  и
                  уничтожаются   все  накопленные  в  буфере
                  ввода, но не считанные процессом символы.

        TTIIOOCCSSEETTNN  Аналогично TTIIOOCCSSEETTPP,  но  не  уничтожаются
                  несчитанные символы.

        TTIIOOCCFFLLUUSSHH Уничтожить  все  символы,  накопленные   в
                  буферах  ввода/вывода.  Параметр arg явля-
                  ется  адресом  переменной,  которая  может
                  принимать   следующие  значения:  FFRREEAADD  -
                  сбросить очередь ввода, FFWWRRIITTEE -  сбросить
                  очередь  вывода,  0  или  (FFRREEAADD|FFWWRRIITTEE) -
                  сбросить обе очереди.

        В следующих запросах параметр _a_r_g игнорируется:

        TTIIOOCCEEXXCCLL  Монопольный захват терминала. Ни один про-
                  цесс  не  сможет  открыть специальный файл
                  данного терминала, пока этот файл не будет
                  закрыт в данном процессе.

        TTIIOOCCNNXXCCLL  Отмена монопольного режима работы с терми-
                  налом.

        TTIIOOCCHHPPCCLL  При последнем закрытии терминала отключить
                  линию связи.

        Для следующих запросов значение параметра _a_r_g  опре-
        деляется  особым  образом, но параметр всегда должен
        присутствовать:

        TTIIOOCCSSTTII   Имитировать  ввод  символа  с   терминала.
                  Параметр  _a_r_g  является указателем на этот
                  символ.

        TTIIOOCCSSBBRRKK  Установить бит _b_r_e_a_k для линии.   Значение
                  параметра _a_r_g не определено.

        TTIIOOCCCCBBRRKK  Очистить бит _b_r_e_a_k  для  линии.   Значение
                  параметра _a_r_g не определено.

        TTIIOOCCSSDDTTRR  Установить бит готовности терминала.  Зна-
                  чение параметра _a_r_g не определено.



                            -9-                        ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        TTIIOOCCCCDDTTRR  Очистить бит готовности терминала.  Значе-
                  ние параметра _a_r_g не определено.

        TTIIOOCCSSPPGGRRPP Установить идентификатор группы  процессов
                  для   терминала.   Параметр  _a_r_g  является
                  идентификатором группы процессов.

        TTIIOOCCGGPPGGRRPP Получить идентификатор  группы  терминала.
                  Параметр _a_r_g - указатель на целую перемен-
                  ную.

        TTIIOOCCOOUUTTQQ  Выдать число символов  в  очереди  вывода.
                  Параметр  _a_r_g  -  указатель  на переменную
                  типа iinntt.  Данный запрос  может  использо-
                  ваться только для работы с терминалом,

        FFIIOONNRREEAADD  Выдать число доступных для  чтения  симво-
                  лов.  Параметр _a_r_g - указатель на перемен-
                  ную  типа  lloonngg.   Данный   запрос   может
                  использоваться не только для работы с тер-
                  миналом, но и для работы с файлами и межп-
                  роцессными каналами.

        TTIIOOCCNNOOTTTTYY Отказ от  управляющего  терминала.  Первый
                  файл-терминал,  который будет открыт, ста-
                  нет для процесса  управляющим  терминалом.
                  Параметр _a_r_g игнорируется.

        Следующая структура описывает  специальные  символы,
        которые  отрабатываются  терминальным  драйвером при
        использовании любой из дисциплин  обслуживания  (_o_l_d
        или _n_e_w). Эта структура определяется в include-файле
        <_s_y_s/_i_o_c_t_l._h>, который автоматически подключается  в
        файле <_s_g_t_t_y._h>.

        ssttrruucctt ttcchhaarrss {
            cchhaarr    tt__iinnttrrcc;  /* Прерывание */
            cchhaarr    tt__qquuiittcc;  /* Выход */
            cchhaarr    tt__ssttaarrttcc; /* Продолжить вывод */
            cchhaarr    tt__ssttooppcc;  /* Приостановить вывод */
            cchhaarr    tt__eeooffcc;   /* Признак конца передачи */
            cchhaarr    tt__bbrrkkcc;   /* Признак конца строки
                                 (дополнително к '\n') */
        };

        Стандартно, эти символы имеют соответственно  значе-
        ния  CCTTRRLL//CC, CCTTRRLL//\\, CCTTRRLL//QQ, CCTTRRLL//SS, CCTTRRLL//DD и \\00337777.
        Значение 0377  отменяет  обработку  соответствующего
        специального  символа.   Символы  tt__ssttaarrttcc и tt__ssttooppcc
        могут иметь одинаковое значение.  В этом случае  при
        первом вводе соответствующего значения ввод приоста-
        навливается, а при  повторном  -  продолжается.  Для
        задания  значений  этих  специальных символов служат
        запросы:

        TTIIOOCCSSEETTCC  Установить значения специальных  символов.
                  Параметр _a_r_g является указателем на струк-
                  туру ttcchhaarrss.


                            -10-                       ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        TTIIOOCCGGEETTCC  Получить текущие значения специальных сим-
                  волов.  Значение  параметра _a_r_g аналогично
                  TTIIOOCCSSEETTCC.

        При  использовании  новой  дисциплины  обслуживания,
        терминальный  драйвер учитывает дополнительную шкалу
        режимов, которая составляется из следующих значений:

        LLCCRRTTBBSS  000001  При отмене введенного символа  выда-
                        вать символ '\b'.

        LLPPRRTTEERRAA 000002  Использовать   алгоритм    индикации
                        отмены символа принятый для печатаю-
                        щих  терминалов.  Удаляемые  символы
                        выдаются  в  обратном  порядке между
                        символами '\' и '/'.

        LLCCRRTTEERRAA 000004  Использовать   алгоритм    индикации
                        отмены  символа  принятый для экрана
                        терминала.   Символы   стираются   с
                        экрана  с помощью последовательность
                        "\b \b".

        LLZZNNAAKK  000010   Обычно на терминалах,  имеющих  про-
                        писные и строчные буквы, отсутствует
                        большой твердый знак  (...  КОИ-8!).
                        Если  установлен  этот  бит,  символ
                        большой  твердый  знак  выводится  с
                        кодом  0377, иначе - преобразуется в
                        маленький твердый знак.

                        Если  терминал  не  имеет   строчных
                        букв,   по  умолчанию  твердый  знак
                        заменяется на символ  "'",  если  же
                        установлен режим LLZZNNAAKK, он выводится
                        как  символ  с  кодом  0177.   Режим
                        LLZZNNAAKK  работает  только при установ-
                        ленном флаге CCYYRRIILLLL.

        LLTTIILLDDEE  000010  Заменять  при  выводе  знак  '~'  на
                        апостроф - для терминалов Hazeltine,
                        работает только при сброшенном флаге
                        CCYYRRIILLLL.

        LLMMDDMMBBUUFF 000020  Останавливать/продолжать  вывод  при
                        потере готовности устройства.

        LLLLIITTOOUUTT 000040  Вывод без каких-либо преобразований.
                        В  отличие  от  режима _R_A_W, произво-
                        дится полная обработка символов  при
                        вводе.

        LLTTOOSSTTOOPP 000100  При попытке вывода на терминал фоно-
                        вому   процессу   посылается  сигнал
                        SSIIGGTTTTOOUU.

        LLFFLLUUSSHHOO 000200  Пропустить текущую порцию  выводимой
                        информации.    Режим   автоматически


                            -11-                       ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


                        отменяется при вводе любого символа.

        LLNNOOHHAANNGG 000400  Не отключать линию при потере готов-
                        ности устройства.

        LLEESSCCHH   001000  Переобразование при выводе  символов
                        '\r'  и  '\b'  в  последовательности
                        "\033M" и "\033H" (используется  для
                        терминала ВТА-2000.15).

        LLCCRRTTKKIILL 002000  Использовать   алгоритм    индикации
                        отмены  входной строки, принятый для
                        экрана терминала. Для стирания  всей
                        строки  с  экрана терминала выдается
                        соответствующее число последователь-
                        ностей "\b \b".

        LLIINNTTRRUUPP 004000  При вводе каждого символа,  процессу
                        передается  сигнал SSIIGGIINNTT.  В данной
                        версии не реализован.

        LLCCTTLLEECCHH 010000  При  эхо-печати  ввода   управляющие
                        символы  преобразуются  в последова-
                        тельность вида ^^_X.

        LLPPEENNDDIINN 020000  Символы,  накопленные   во   входном
                        буфере,  вторично обрабатываются при
                        очередном чтении. Это режим  исполь-
                        зуется  самим  драйвером и обычно не
                        устанавливается       пользователем.
                        Действует  на одно обращение к драй-
                        веру.

        LLDDEECCCCTTQQ 040000  Для  остановки  вывода  на  терминал
                        используется                  символ
                        tt__ssttaarrttcc(CCTTRRLL//SS), а для  продолжения
                        только    символ    tt__ssttooppcc(CCTTRRLL//QQ).
                        Стандартно, любой введенный  символ,
                        кроме  символа tt__ssttooppcc вызывает про-
                        должение вывода.

        LLNNOOFFLLSSHH 100000  Обычно    при     вводе     символов
                        tt__iinnttrrcc(CCTTRRLL//CC)   и  tt__qquuiittcc(CCTTRRLL//\\)
                        драйвер  опустошает  очередь  ждущих
                        вывода  символов.   Установка  флага
                        LLNNOOFFLLSSHH отменяет это действие.

        Для установки  этих  режимов  применяются  следующие
        запросы  системного вызова iiooccttll (параметр _a_r_g явля-
        ется указателем на целую переменную):

        TTIIOOCCLLBBIISS  Установить дополнительные режимы, заданные
                  параметром _a_r_g.

        TTIIOOCCLLBBIICC  Отменить дополнительные  режимы,  заданные
                  параметром _a_r_g.

        TTIIOOCCLLSSEETT  Присвоить  шкале  дополнительных   режимов


                            -12-                       ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


                  значение параметра _a_r_g.

        TTIIOOCCLLGGEETT  Получить  значение  шкалы   дополнительных
                  режимов.

        Следующая структура определяет специальные  символы,
        которые  обрабатываются  только  в  новой дисциплине
        обслуживания:

        ssttrruucctt llttcchhaarrss {
            cchhaarr tt__ssuussppcc;  /* Останов процесса */
            cchhaarr tt__ddssuussppcc; /* Отложенный останов
                              процесса */
            cchhaarr tt__rrpprrnnttcc; /* Перевыдача входной строки */
            cchhaarr tt__fflluusshhcc; /* Пропуск выходной
                              информации */
            cchhaarr tt__wweerraasscc; /* Отмена последнего
                              введенного слова */
            cchhaarr tt__llnneexxttcc; /* Ввод следующего символа
                              без какой-либо обработки */
        };

        Стандартно, эти символы имеют соответственно  значе-
        ния CCTTRRLL//ZZ, CCTTRRLL//YY, CCTTRRLL//RR, CCTTRRLL//TT, CCTTRRLL//WW и CCTTRRLL//VV.
        Значение '\0377' используется для  отмены  обработки
        соответствующего специального символа.

        Для управления значениями этих символов  применяются
        следующие запросы системного вызова iiooccttll:

        TTIIOOCCSSLLTTCC  Установить значения дополнительных  специ-
                  альных  символов.   Параметр  _a_r_g является
                  указателем на структуру типа llttcchhaarrss.

        TTIIOOCCGGLLTTCC  Получить текущие  значения  дополнительных
                  специальных  символов.  Параметр _a_r_g явля-
                  ется указателем на структуру типа llttcchhaarrss.

        Все перечисленные режимы работы терминального  драй-
        вера могут быть получены с помощью одного системного
        вызова:

                ssttrruucctt ssggttttyyaa _t_t_y;
                iiooccttll (_f_d, TTIIOOCCGGEETTAA, &_t_t_y);

        где _t_t_y -  является  общей  управляющей  структурой,
        которая  содержит полную информацию о режимах работы
        драйвера и имеет вид:

        ssttrruucctt ssggttttyyaa {{
         //** ББааззооввыыее ппааррааммееттррыы **//
            cchhaarr    ssgg__iissppeeeedd;
            cchhaarr    ssgg__oossppeeeedd;
            cchhaarr    ssgg__eerraassee;
            cchhaarr    ssgg__kkiillll;
            sshhoorrtt   ssgg__ffllaaggss;
         /* Значения задержек */
            cchhaarr    ssgg__nnllddllyy;   /* для \n */


                            -13-                       ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


            cchhaarr    ssgg__ccrrddllyy;   /* для \r */
            cchhaarr    ssgg__hhttddllyy;   /* для \t */
            cchhaarr    ssgg__vvttddllyy;   /* для \f */
         /* Размеры экрана */
            cchhaarr    ssgg__wwiiddtthh;   /* длина строки */
            cchhaarr    ssgg__lleennggtthh;  /* число строк */
         /* Дополнительная шкала режимов */
            sshhoorrtt   ssgg__llooccaall;
         /* Основные специальные символы */
            cchhaarr    ssgg__iinnttrrcc;
            cchhaarr    ssgg__qquuiittcc;
            cchhaarr    ssgg__ssttaarrttcc;
            cchhaarr    ssgg__ssttooppcc;
            cchhaarr    ssgg__eeooffcc;
            cchhaarr    ssgg__bbrrkkcc;
         /* Дополнительные специальные символы */
            cchhaarr    ssgg__ssuussppcc;
            cchhaarr    ssgg__ddssuussppcc;
            cchhaarr    ssgg__rrpprrnnttcc;
            cchhaarr    ssgg__fflluusshhcc;
            cchhaarr    ssgg__wweerraasscc;
            cchhaarr    ssgg__llnneexxttcc;
        };

        Установить режимы работы драйвера  терминалов  можно
        при  помощи  запросов  iiooccttll TTIIOOCCSSEETTAA и TTIIOOCCSSEETTBB.  В
        качестве аргумента этим запросам  указывается  адрес
        структуры  ssggttttyyaa;  запрос TTIIOOCCSSEETTAA перед установкой
        новых параметров сбрасывает  очередь  введенных,  но
        еще  не прочитанных программами символов (аналогично
        TTIIOOCCSSEETTPP), а запрос TTIIOOCCSSEETTBB - не сбрасывает (анало-
        гично TTIIOOCCSSEETTNN).

        В поле ssgg__wwiiddtthh структуры ssggttttyyaa для терминалов,  не
        имеющих  автоматического  переноса  слишком  длинных
        строк, нужно установить ширину  экрана.  Значение  0
        отменяет перенос строк драйвером, возлагая эту функ-
        цию на аппаратуру.  Поле ssgg__lleennggtthh в текущей  версии
        драйвера не используется.

        Поля ssgg__nnllddllyy, ssgg__ccrrddllyy, ssgg__hhttddllyy и ssgg__vvttddllyy  содер-
        жат  длительность  задержек, которые будет отрабаты-
        вать драйвер после вывода символов  _п_е_р_е_в_о_д  _с_т_р_о_к_и,
        _в_о_з_в_р_а_т  _к_а_р_е_т_к_и,  _т_а_б_у_л_я_ц_и_я  и _п_р_о_г_о_н _ф_о_р_м_а_т_а соот-
        ветственно. Значения длительности задержек  задаются
        в  тиках  (в  СССР  на машинах типа СМ-4 и т.п. - 20
        мсек) от 0 до  127  тиков.   Если  в  коде  значения
        задержки  дополнительно установлен бит 0200, драйвер
        будет использовать _в_ы_ч_и_с_л_я_е_м_ы_е задержки,  исходя  из
        среднего значения длины строки, равного 32 символам.

        Если пользовательская программа  выводит  символы  с
        кодами  от 0201 до 0277, драйвер также будет отраба-
        тывать задержки с длительностью

                _к_о_д _с_и_м_в_о_л_а - 0200

        тиков. Эта  возможность  драйвера  не  работает  при


                            -14-                       ДЕМОС


TTY(4)            ДЕМОС. Специальные файлы            TTY(4)


        установленном  8-битном режиме (RRAAWW, LLLLIITTOOUUTT, CCBBIITTSS88
        или CCBBIITTSS88QQ).

ФФААЙЙЛЛЫЫ
        /_d_e_v/_t_t_y        управляющий терминал процесса
        /_d_e_v/_t_t_y*
        /_d_e_v/_c_o_n_s_o_l_e    спецфайлы терминалов

ДДООППООЛЛННИИТТЕЕЛЛЬЬННЫЫЕЕ ССССЫЫЛЛККИИ
        _s_t_t_y(1),  _c_s_h(1),  _i_o_c_t_l(2),  _s_i_g_n_a_l(2),   _g_e_t_t_y(8),
        _i_n_i_t(8)

ЗЗААММЕЕЧЧААННИИЯЯ
        Не обслуживаются терминалы,  работающие  в  полудуп-
        лексном режиме.

        Универсальный терминальный  драйвер  берет  на  себя
        выполнение  абсолютно  не свойственных ему функций -
        управление процессами.

        Для установки и чтения режимов работы драйвера  тер-
        миналов   вполне   достаточно   запросов   TTIIOOCCSSEETTAA,
        TTIIOOCCSSEETTBB и  TTIIOOCCGGEETTAA,  остальные  запросы  оставлены
        исключительно  по  соображениям  совместимости  (и в
        будущем, скорей всего, исчезнут).



































                            -15-                       ДЕМОС

