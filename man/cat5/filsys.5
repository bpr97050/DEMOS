
FILSYS(5)          ДЕМОС. Форматы файлов           FILSYS(5)


ИИММЯЯ
       ffiillssyyss, ffbbllkk, iinnoo - формат файловой системы.

ФФООРРММААТТ
       #iinncclluuddee <_s_y_s/_p_a_r_a_m._h>
       #iinncclluuddee <_s_y_s/_t_y_p_e_s._h>
       #iinncclluuddee <_s_y_s/_f_l_b_k._h>
       #iinncclluuddee <_s_y_s/_f_i_l_s_y_s._h>
       #iinncclluuddee <_s_y_s/_i_n_o._h>

ООППИИССААННИИЕЕ
       Каждый том, на  котором  хранится  файловая  система,
       содержит  служебную  информацию,  для  которой введен
       общий формат. Каждый том делится на  некоторое  число
       логических  блоков  по  BBSSIIZZEE  байтов  (определено  в
       <_s_y_s/_p_a_r_a_m._h>,  в  текущей  версии  системы  -   1024
       байта).   Блок  0  не  используется и может содержать
       программу самозагрузки или другую информацию.

       Блок  1  называется  суперблоком.  Формат  суперблока
       определен в include-файле <_s_y_s/_f_i_l_s_y_s._h>:

       /*
        * Структура суперблока
        */
       ssttrruucctt ffiillssyyss {
           uu__sshhoorrtt ss__iissiizzee;     /* размер I-списка */
           ddaaddddrr__tt ss__ffssiizzee;     /* размер файл. системы */
           sshhoorrtt   ss__nnffrreeee;     /* # указ. на своб. блоки */
           ddaaddddrr__tt ss__ffrreeee[NNIICCFFRREEEE];  /* своб. блоки */
           sshhoorrtt   ss__nniinnooddee;    /* # указ.на своб.I-узлы */
           iinnoo__tt   ss__iinnooddee[NNIICCIINNOODD]; /* своб. I-узлы */
           cchhaarr    ss__fflloocckk;     /* блокировка файл.сист. */
           cchhaarr    ss__iilloocckk;     /* блокировка по I-узлам */
           cchhaarr    ss__ffmmoodd;      /* суперблок изменился */
           cchhaarr    ss__rroonnllyy;     /* защита от записи */
           ttiimmee__tt  ss__ttiimmee;      /* время модификации */
           ddaaddddrr__tt ss__ttffrreeee;     /* всего своб. блоков */
           iinnoo__tt   ss__ttiinnooddee;    /* всего своб. I-узлов */
           sshhoorrtt   ss__ddiinnffoo[2];  /* параметры интерливинга */
       #ddeeffiinnee ss__mm     ss__ddiinnffoo[0]   /* М-фактор */
       #ddeeffiinnee ss__nn     ss__ddiinnffoo[1]   /* N-фактор */
           cchhaarr    ss__ffssmmnntt[12]; /* имя для монтирования */
           iinnoo__tt   ss__llaassttii;     /* эти два поля нужны ал- */
           iinnoo__tt   ss__nnbbeehhiinndd;   /* горитму выбора I-узла  */
           cchhaarr    ss__ffppaacckk[6];  /* уникальное имя тома */
       };

       Поле  ss__iissiizzee  содержит  номер  первого  блока  после
       списка  I-узлов  (один  I-узел  описывает один файл),
       начинающегося сразу же после суперблока, т.е. с блока
       2. Таким образом, длина списка I-узлов в блоках выра-
       жается величиной ii__iissiizzee-2.   Поле  ss__ffssiizzee  содержит
       адрес  первого  блока,  который не может быть выделен
       для размещения файлов.  Эти адреса используются  сис-
       темой  для  обнаружения  неправильных адресов блоков.
       Если происходит освобождение или выделение из  списка
       свободного    пространства    некоторого    блока   с


                            -1-                      ДЕМОС/P


FILSYS(5)          ДЕМОС. Форматы файлов           FILSYS(5)


       недопустимым адресом, на консоль поступает диагности-
       ческое  сообщение.   Кроме  того,  список  свободного
       пространства обнуляется, чтобы предотвратить дальней-
       шее  выделение  блоков  из этого, вероятно поврежден-
       ного, списка.

       Ведение списка свободного пространства в каждом  томе
       осуществляется   следующим   образом:  массив  ss__ffrreeee
       содержит     в     элементах     ss__ffrreeee[1],      ...,
       ss__ffrreeee[ss__nnffrreeee-1]  не более NNIICCFFRREEEE номеров свободных
       блоков.  Для заданной  конфигурации  системы  NNIICCFFRREEEE
       является  константой  (определена  в  <_s_y_s/_p_a_r_a_m._h>).
       Элемент ss__ffrreeee[0] содержит адрес  блока,  являющегося
       заголовком  цепочки блоков, образующих список свобод-
       ного  пространства.  Формат  каждого  блока  в   этой
       цепочке определен в системном файле <_s_y_s/_f_b_l_k._h>:

       ssttrruucctt ffbbllkk {
           sshhoorrtt   ddff__nnffrreeee;  /* число указателей */
                              /* на свободные блоки */
           ddaaddddrr__tt ddff__ffrreeee[NNIICCFFRREEEE]; /* указатели */
       };

       Поля ddff__nnffrreeee и ddff__ffrreeee в свободном  блоке  использу-
       ются  точно  так  же,  как  и поля ss__nnffrreeee и ss__ffrreeee в
       суперблоке.  Чтобы распределить некоторый блок, необ-
       ходимо  уменьшить  на единицу значение ss__nnffrreeee, тогда
       номером нового  блока  будет  ss__ffrreeee[ss__nnffrreeee].   Если
       адрес блока равен нулю, это означает, что не осталось
       ни одного свободного блока, в  этом  случае  выдается
       сообщение   об  ошибке.  Если значение ss__nnffrreeee стано-
       вится равным нулю, новый блок считывается по  адресу,
       определенному полями ss__nnffrreeee и ss__ffrreeee.  Чтобы освобо-
       дить блок, проверяется, равны ли величины  ss__nnffrreeee  и
       NNIICCFFRREEEE.   Eсли равны, то в этот блок копируются мас-
       сивы ss__nnffrreeee и ss__ffrreeee, затем блок выводится во  внеш-
       нюю  память,  и  в поле ss__nnffrreeee устанавливается 0.  В
       любом случае в поле  ss__ffrreeee[ss__nnffrreeee]  устанавливается
       адрес освобожденного блока, а содержимое поля ss__nnffrreeee
       увеличивается на единицу.

       Поле ss__nniinnooddee содержит  число  номеров  свободных  I-
       узлов  в массиве ss__iinnooddee.  Чтобы распределить I-узел,
       необходимо выполнить следующие операции:

              Eсли значение ss__nniinnooddee больше 0, то оно умень-
              шается  на  единицу  и  возвращается  значение
              ss__iinnooddee[ss__nniinnooddee].

              Если это  значение  равно  0,  просматривается
              область  I-узлов, считываются номера всех сво-
              бодных I-узлов (вплоть до NNIICCIINNOODD,  определен-
              ном  в  <_s_y_s/_p_a_r_a_m._h>)  и  помещаются а массив
              ss__iinnooddee, после чего повторяется предшествующий
              шаг.

       Чтобы освободить I-узел, при  условии,  что  значение
       ss__nniinnooddee   меньше   величины  NNIICCIINNOODD,  номер  I-узла


                            -2-                      ДЕМОС/P


FILSYS(5)          ДЕМОС. Форматы файлов           FILSYS(5)


       помещается в  поле  ss__iinnooddee[ss__nniinnooddee],  а  содержимое
       поля ss__nniinnooddee увеличивается на единицу. Если значение
       ss__nniinnooddeeee уже равно величине  NNIICCIINNOODD,  освобожденный
       I-узел не следует включать в какую-либо таблицу. Спи-
       сок I-узлов служит лишь для ускорения процесса  расп-
       ределения:  информация  о  том,  является  ли  I-узел
       действительно свободным или нет, содержится  в  самом
       I-узле.

       Поля ss__fflloocckk и ss__iilloocckk служат флагами,  устанавливае-
       мыми  для находящейся в основной памяти копии системы
       файлов, существующей во  время  установки  тома  этой
       системы,  поэтому  содержимое  этих полей на диске не
       имеет значения.  Также  несущественно  записанное  на
       диск значение ss__ffmmoodd, которое используется в качестве
       флага, указывающего на то, что суперблок был  изменен
       и должен быть скопирован на диск при следующей перио-
       дической корректировке информации о  системе  файлов.
       Поле ss__rroonnllyy служит признаком защиты от записи; запи-
       санное на диск значение этого  поля  также  несущест-
       венно.

       Поле  ss__ttiimmee  указывает  время  последнего  изменения
       суперблока.  Во время загрузки содержимое поля ss__ttiimmee
       корневой файловой системы используется для  установки
       системного времени.

       Номера I-узлов начинаются с 1, а область I-узлов раз-
       мещается,  начиная  с  блока 2.  I-узел состоит из 64
       байтов, в одном блоке  помещается  IINNOOPPBB  узлов  (или
       BBSSIIZZEE/64,  IINNOOPPBB определен в <_s_y_s/_i_n_o._h>).  Второй I-
       узел зарезервирован для корневого  каталога  файловой
       системы,  первый  I-узел  описывает  файл, содержащий
       дефектные секторы носителя, остальные I-узлы не имеют
       заранее определенного назначения.  Каждый I-узел опи-
       сывает один файл. Формат I-узла определен в системном
       файле <_s_y_s/_i_n_o._h>:

       /*
        * Структура I-узла (на диске).
        */
       ssttrruucctt ddiinnooddee {
           uu__sshhoorrtt ddii__mmooddee;  /* статус файла */
           sshhoorrtt   ddii__nnlliinnkk; /* число ссылок на файл */
           sshhoorrtt   ddii__uuiidd;   /* идент. пользователя */
           sshhoorrtt   ddii__ggiidd;   /* идент. группы */
           ooffff__tt   ddii__ssiizzee;  /* размер файла в байтах */
           cchhaarr    ddii__aaddddrr[40]; /* адреса блоков */
                                /* 7 адресов по 3 */
                                /* байта на адрес */
           ttiimmee__tt  ddii__aattiimmee; /* время посл. доступа */
           ttiimmee__tt  ddii__mmttiimmee; /* время посл. модификации */
           ttiimmee__tt  ddii__ccttiimmee; /* время создания файла */
       };

       #ddeeffiinnee IINNOOPPBB   16        /* число I-узлов на блок */

       Поле ddii__mmooddee указывает тип файла (оно кодируется  так


                            -3-                      ДЕМОС/P


FILSYS(5)          ДЕМОС. Форматы файлов           FILSYS(5)


       же,  как поле sstt__mmooddee для системного вызова _s_t_a_t(2)).
       Поле ddii__nnlliinnkk содержит число элементов каталога (свя-
       зей),  относящихся  к  данному I-узлу.  Поля ddii__uuiidd и
       ddii__ggiidd содержат  идентификаторы  владельца  и  группы
       пользователей.  Поле ddii__ssiizzee указывает число байтов в
       файле. Поля ddii__aattiimmee и ddii__mmttiimmee указывают время  пос-
       леднего  доступа к файлу и время последнего изменения
       его содержимого (т.е. время  считывания,  записи  или
       создания:  см.   _t_i_m_e(2));  В  поле ddii__ccttiimmee записано
       время последнего изменения I-узла или  самого  файла:
       это  поле  используется, чтобы определить, необходимо
       ли копирование файла на ленту дампа.

       Специальные файлы распознаются по полю ddii__mmooddee, а  не
       по  содержимому  остальных полей или номерам I-узлов.
       Файл, который может быть смонтирован в качестве смен-
       ного тома файловой системы, называется блочным специ-
       альным файлом; символьные специальные файлы не  могут
       служить  таким  томом,  хотя  и не обязательно должны
       быть ориентированы на символьную обработку. Для  спе-
       циальных  файлов поле ddii__aaddddrr занято кодом устройства
       (см.  _t_y_p_e_s(5)).  Коды устройств для блочных  и  сим-
       вольных специальных файлов могут совпадать.

       Для простых файлов и каталогов физические адреса раз-
       мещения  на  диске  содержатся в массиве ddii__aaddddrr, где
       каждый адрес упакован в  3  байта.  Первые  4  адреса
       непосредственно указывают блоки устройства. Последние
       3 адреса  являются  косвенными  (первого,  второго  и
       третьего  уровня) и указывают на блоки, содержащие по
       256 (BBSSIIZZEE/ssiizzeeooff(_d_a_d_d_r__t)) указателей блоков. Указа-
       тели,  содержащиеся  в  блоках  косвенной  адресации,
       имеют тип ddaaddddrr__tt (см.  _t_y_p_e_s(5)).

       Для того, чтобы в некотором файле существовал блок _X,
       не  необходимо,  чтобы существовали все блоки с номе-
       рами, меньшими _X.  Нулевой номер блока,  присутствую-
       щий  либо  в адресном слове I-узла, либо в блоке кос-
       венной адресации, указывает на то, что  соответствую-
       щий   блок  никогда  не  распределяется.   Считывание
       отсутствующего блока дает  такой  же  результат,  как
       если бы этот блок содержал нулевые слова.

ДДООППООЛЛННИИТТЕЕЛЛЬЬННЫЫЕЕ ССССЫЫЛЛККИИ
       _s_t_a_t(2),  _d_i_r(5),   _t_y_p_e_s(5),   _f_s_c_k(8),   _i_c_h_e_c_k(8),
       _m_o_u_n_t(8)














                            -4-                      ДЕМОС/P

